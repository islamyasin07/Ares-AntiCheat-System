<div class="ml-dashboard container">
  <div class="header">
    <div class="left">
      <h2>AI / ML Dashboard</h2>
      <p class="muted">Realtime ML detections & model insights — professional view</p>
    </div>

    <div class="right actions">
      <input class="search" placeholder="Search player or id" [(ngModel)]="filters.query" (keyup.enter)="applyFilters()" />
      <button class="btn ghost" (click)="resetFilters()">Reset</button>
      <button class="btn" (click)="forceReload()" title="Reload now">Reload</button>
      <button class="btn ghost" (click)="seedSample()">Seed Sample</button>
      <button class="btn primary" (click)="triggerScan()">Run Scan All</button>
    </div>
  </div>

  <div class="hero-row">
    <app-ml-overview></app-ml-overview>
    <app-glow-card class="top-cheaters-card">
      <h3>Top Cheaters</h3>
      <ul *ngIf="topCheaters.length>0" class="top-list compact">
        <li *ngFor="let p of topCheaters | slice:0:8">
          <a [routerLink]="['/ml/player', p.playerId || p.player_id]">{{ p.playerId || p.player_id }}</a>
          <span class="meta">{{ p.suspicious_events_count || p.count || 0 }} events • Avg {{ (p.avg_prob||0) | percent:'1.0-2' }}</span>
        </li>
      </ul>
      <div *ngIf="topCheaters.length===0" class="empty">No top cheaters</div>
    </app-glow-card>

    <app-glow-card class="pie-card">
      <h3>Risk Distribution</h3>
      <app-ares-pie-chart [labels]="riskLabels" [data]="riskData"></app-ares-pie-chart>
    </app-glow-card>
  </div>

  <div class="main-grid">
    <app-glow-card class="detections-card">
      <div class="card-header">
        <h3>Recent ML Detections</h3>
        <div class="card-actions">
          <button class="btn ghost" (click)="exportCSV()" [disabled]="liveDetections.length===0">Export CSV</button>
        </div>
      </div>

      <div *ngIf="loading" class="skeleton-list">
        <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5]"></div>
      </div>

      <div *ngIf="!loading && liveDetections.length === 0" class="empty">No detections found.</div>

      <table *ngIf="!loading && liveDetections.length > 0" class="detections-table modern">
        <thead>
          <tr><th>Time</th><th>Player</th><th>Risk</th><th>Probability</th><th>Actions</th></tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of liveDetections">
            <td>{{ d.detected_at | date:'short' }}</td>
            <td><a [routerLink]="['/ml/player', d.player_id]" class="player-link">{{ d.player_id }}</a></td>
            <td><span class="risk badge" [attr.data-level]="d.risk_level">{{ d.risk_level }}</span></td>
            <td>
              <div class="prob-wrap"><div class="prob-bar" [style.width.%]="((d.cheat_probability||0)*100)"></div><div class="prob-text">{{ (d.cheat_probability||0) | percent:'1.0-2' }}</div></div>
            </td>
            <td>
              <button class="btn ghost" (click)="router.navigate(['/ml/player', d.player_id])">View</button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="pager">
        <button class="btn" (click)="prevPage()" [disabled]="page <= 1">Prev</button>
        <span>Page {{ page }} · {{ total }} results</span>
        <button class="btn" (click)="nextPage()" [disabled]="page * limit >= total">Next</button>
      </div>
    </app-glow-card>

    <div class="right-column">
      <app-glow-card class="chart-card">
        <h3>Confidence Distribution</h3>
        <app-ares-line-chart [labels]="['0-10','10-20','20-30','30-40','40-50','50-60','60-70','70-80','80-90','90-100']" [data]="confidenceBins"></app-ares-line-chart>
      </app-glow-card>

      <app-glow-card class="recent-stream">
        <h3>Live Stream</h3>
        <div class="live-list compact">
          <div *ngFor="let d of liveDetections.slice(0,8)" class="live-item">
            <div class="left"><strong>{{ d.player_id }}</strong> <span class="mini">{{ d.risk_level }}</span></div>
            <div class="right">{{ d.detected_at | date:'shortTime' }}</div>
          </div>
        </div>
      </app-glow-card>
    </div>
  </div>
</div>